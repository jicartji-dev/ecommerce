{% extends "cj_admin/cj_base.html" %}
{% block content %}

<h1>
    {% if is_edit %}Edit Product{% else %}Add Product{% endif %}
</h1>

<form method="post" enctype="multipart/form-data" class="cj-form">
    {% csrf_token %}

    <div class="cj-form-card">
    <h3>Basic Information</h3>

    <div class="cj-form-grid">
        <div>
            {{ product_form.category.label_tag }}
            {{ product_form.category }}
        </div>

        <div>
            {{ product_form.subcategory.label_tag }}
            {{ product_form.subcategory }}
        </div>

        <div class="full">
            {{ product_form.name.label_tag }}
            {{ product_form.name }}
        </div>
    </div>
    </div>

<div class="cj-form-card">
    <h3>Pricing</h3>

    <div class="cj-form-grid">
        <div>
            {{ product_form.original_price.label_tag }}
            {{ product_form.original_price }}
        </div>

        <div>
            {{ product_form.discount_price.label_tag }}
            {{ product_form.discount_price }}
        </div>
    </div>
</div>
    <div class="cj-form-card">
    <h3>Inventory & Visibility</h3>

    <div class="cj-form-grid">
        <div class="full">
            <label>Sizes</label>

<div class="cj-size-wrapper">
    {% for checkbox in product_form.sizes %}
        <label class="cj-size-pill">
            {{ checkbox.tag }}
            <span>{{ checkbox.choice_label }}</span>
        </label>
    {% endfor %}
</div>

<small>
    <a href="{% url 'cj_size_add' %}" target="_blank">➕ Add new size</a>
</small>
            
        </div>

        <div>
            {{ product_form.stock_status.label_tag }}
            {{ product_form.stock_status }}
        </div>

        <div>
            {{ product_form.is_featured.label_tag }}
            {{ product_form.is_featured }}
        </div>

        <div>
            {{ product_form.is_active.label_tag }}
            {{ product_form.is_active }}
        </div>
    </div>
    </div>
    
    
    <h3>Description</h3>
    <div class="cj-form-section">
        {{ product_form.description.label_tag }}
        {{ product_form.description }}
    </div>

    

    <hr>

    <h3>Product Images</h3>
    <div style="margin-bottom: 8px;">
        <a href="{% url 'cj_color_add' %}" target="_blank">
            ➕ Add new Color
        </a>
    </div>

    {{ image_formset.management_form }}

    <div id="image-formset">
        {% for form in image_formset %}
        <div class="cj-image-card">
    {{ form.image.label_tag }}
    {{ form.image }}

    {{ form.color.label_tag }}
    {{ form.color }}

    <div style="margin-top:8px">
        {{ form.DELETE }} Delete
    </div>
        </div>
        
        {% endfor %}
    </div>

    <button type="button" class="cj-btn" onclick="addImageForm()">
        + Add Another Image
    </button>

    <br><br>

    <button class="cj-btn primary">
        {% if is_edit %}Update Product{% else %}Save Product{% endif %}
    </button>
</form>

<script>
    function addImageForm() {
        const formset = document.getElementById("image-formset");
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");

        let count = parseInt(totalForms.value);
        let newForm = formset.children[0].cloneNode(true);

        newForm.innerHTML = newForm.innerHTML.replaceAll(
            /form-(\d+)-/g,
            `form-${count}-`
        );

        newForm.querySelectorAll("input, select").forEach(el => {
            el.value = "";
            if (el.type === "checkbox") el.checked = false;
        });

        formset.appendChild(newForm);
        totalForms.value = count + 1;
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {

        const categorySelect = document.getElementById("id_category");
        const subCategorySelect = document.getElementById("id_subcategory");

        if (!categorySelect || !subCategorySelect) return;

        categorySelect.addEventListener("change", function () {

            const categoryId = this.value;
            subCategorySelect.innerHTML = "<option value=''>Loading...</option>";

            if (!categoryId) {
                subCategorySelect.innerHTML = "<option value=''>---------</option>";
                return;
            }

            fetch(`/cj-admin/get-subcategories/?category=${categoryId}`)
                .then(res => res.json())
                .then(data => {

                    subCategorySelect.innerHTML = "<option value=''>---------</option>";

                    data.forEach(sub => {
                        const option = document.createElement("option");
                        option.value = sub.id;
                        option.textContent = sub.name;
                        subCategorySelect.appendChild(option);
                    });

                });
        });
    });
</script>


{% endblock %}
