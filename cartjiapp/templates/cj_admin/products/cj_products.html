{% extends "cj_admin/cj_base.html" %}

{% block content %}

<h1>Products</h1>
<a href="{% url 'cj_product_add' %}" class="cj-btn primary">
    + Add Product
</a>
<form method="get" class="cj-filter-bar">
    <input type="text" name="search" placeholder="Search product..." value="{{ request.GET.search }}">

    <select name="category" id="category-select">
        <option value="">All Categories</option>
        {% for cat in categories %}
        <option value="{{ cat.id }}" {% if selected_category == cat.id %}selected{% endif %}>
            {{ cat.name }}
        </option>
        {% endfor %}
    </select>


    <select name="subcategory" id="subcategory-select">
        <option value="">All Sub Categories</option>
        {% for sub in subcategories %}
        <option value="{{ sub.id }}" {% if selected_subcategory == sub.id %}selected{% endif %}>
            {{ sub.category.name }} â†’ {{ sub.name }}
        </option>
        {% endfor %}
    </select>

    <select name="stock">
        <option value="">All Stock</option>
        <option value="in_stock" {% if request.GET.stock == "in_stock" %}selected{% endif %}>In Stock</option>
        <option value="out_of_stock" {% if request.GET.stock == "out_of_stock" %}selected{% endif %}>Out of Stock</option>
    </select>

    <select name="featured">
        <option value="">Featured?</option>
        <option value="yes" {% if request.GET.featured == "yes" %}selected{% endif %}>Yes</option>
        <option value="no" {% if request.GET.featured == "no" %}selected{% endif %}>No</option>
    </select>

    <a href="{% url 'cj_products' %}" class="cj-btn">Reset</a>
</form>

<div id="products-table">
    {% include "cj_admin/products/_products_table.html" %}
</div>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        const categorySelect = document.getElementById("category-select");
        const subcategorySelect = document.getElementById("subcategory-select");

        categorySelect.addEventListener("change", function () {
            const categoryId = this.value;

            // reset subcategory
            subcategorySelect.innerHTML =
                '<option value="">All Sub Categories</option>';

            if (!categoryId) return;

            fetch("{% url 'cj_get_subcategories' %}?category=" + categoryId)
                .then(response => response.json())
                .then(data => {
                    const selectedSub = new URLSearchParams(window.location.search).get("subcategory");

                    data.forEach(sub => {
                        const option = document.createElement("option");
                        option.value = sub.id;
                        option.textContent = sub.name;

                        if (selectedSub == sub.id) {
                            option.selected = true;
                        }

                        subcategorySelect.appendChild(option);
                    });
                });

        });
    
        const filterForm = document.querySelector(".cj-filter-bar");
        const tableWrapper = document.getElementById("products-table");

        filterForm.addEventListener("change", submitFilters);
        filterForm.addEventListener("submit", function (e) {
            e.preventDefault();
            submitFilters();
        });

        function submitFilters() {
            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData).toString();

            fetch(`?${params}`, {
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
                .then(res => res.json())
                .then(data => {
                    tableWrapper.innerHTML = data.html;
                });
        }
    });
</script>



{% endblock %}